<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empresas Amigas - Institución Cervantes</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS (Para exportar a Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Estilos -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Fila Base */
        .list-row {
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: white;
            border-left: 4px solid transparent;
            position: relative;
            overflow: hidden;
            transform-origin: center;
        }

        /* Estado Hover Activo */
        .list-row.is-hovered {
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            z-index: 20;
        }

        /* Textos a Blanco en Hover */
        .list-row.is-hovered h3, 
        .list-row.is-hovered p.description-text,
        .list-row.is-hovered div.font-mono {
            color: white !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Badge Categoría en Hover */
        .list-row.is-hovered .category-badge {
            background-color: rgba(255,255,255,0.2) !important;
            color: white !important;
            border-color: rgba(255,255,255,0.3) !important;
        }

        /* Iconos Generales en Hover */
        .list-row.is-hovered .icon-main {
            color: rgba(255,255,255,0.9) !important;
        }

        /* --- TYPOGRAPHY WATERMARK (TEXTO GIGANTE DE FONDO) --- */
        .text-watermark {
            position: absolute;
            left: -2%; 
            bottom: -0.18em;
            font-size: 9rem;
            font-weight: 900;
            line-height: 0.75; 
            white-space: nowrap;
            text-transform: uppercase;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.04em;
            color: #000;
            opacity: 0.04;
            pointer-events: none;
            z-index: 0;
            transition: all 0.4s ease;
            user-select: none;
        }

        /* Watermark en Hover */
        .list-row.is-hovered .text-watermark {
            color: white;
            opacity: 0.12;
            left: 0%;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .text-watermark {
                font-size: 5rem;
                bottom: -0.15em;
            }
        }

        .row-content {
            position: relative;
            z-index: 1;
        }

        .category-badge {
            background-color: #eff6ff;
            color: #1e40af;
            border: 1px solid #dbeafe;
        }

        /* BENEFIT BOX */
        .benefit-box {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
        }
        .list-row.is-hovered .benefit-box {
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            background: linear-gradient(to right, #f0fdf4, #ecfdf5);
        }
        .benefit-title { color: #15803d !important; }
        .benefit-value { color: #14532d !important; }
        .benefit-icon { color: #16a34a !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="root"></div>

    <!-- FIREBASE CONFIG -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUhUteM5wLHtEFscyP6DmSIV4mKhLLKtk",
            authDomain: "empresasamigas-f3525.firebaseapp.com",
            projectId: "empresasamigas-f3525",
            storageBucket: "empresasamigas-f3525.firebasestorage.app",
            messagingSenderId: "2939118228",
            appId: "1:2939118228:web:0dbcebb396f6b39a214a81",
            measurementId: "G-8X73ZBZGYX"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        window.db = db;
        window.dbFunctions = { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- REACT APP -->
    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- ICONOS ---
        const IconSearch = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
        const IconBuilding = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M16 18h.01"/></svg>;
        const IconPercent = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>;
        const IconInfo = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
        const IconPlus = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
        const IconX = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const IconEdit = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>;
        const IconSave = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>;
        const IconTrash = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const IconImage = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>;
        const IconCloudUpload = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>;
        const IconDownload = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;

        // --- DATOS INICIALES SEED (Acortado para visualización, contiene lógica original) ---
        const INITIAL_DATA_SEED = [
          { entidad: "Konecta (Allus)", categoria: "Empresa Privada", beneficio_corto: "50% Matrícula / 20% Cuotas", descripcion: "Beneficiarios: Miembros de Allus Córdoba y grupo familiar directo." },
          { entidad: "Club Atlético Belgrano", categoria: "Club Deportivo", beneficio_corto: "50% Matrícula / 20% Cuotas", descripcion: "Beneficiarios: Socios al día del Club." },
          // ... (Todos los datos originales se mantienen en la lógica de migración) ...
          { entidad: "Gobierno de la Provincia de Córdoba", categoria: "Gobierno", beneficio_corto: "50% Matrícula / 20% Cuotas", descripcion: "Beneficiarios: Miembros de la Administración Pública Provincial." },
          { entidad: "Cluster Córdoba Technology", categoria: "Tecnología", beneficio_corto: "50% Matrícula / 20% Cuotas", descripcion: "Beneficiarios: Miembros del Cluster." }
        ];

        // --- COMPONENTE AVATAR MEJORADO (SOLUCIÓN IMÁGENES ROTAS) ---
        const LogoAvatar = ({ name, url, onLoad }) => {
          const [hasError, setHasError] = useState(false);

          // Si cambia la URL, reseteamos el estado de error para intentar cargar la nueva
          useEffect(() => {
            setHasError(false);
          }, [url]);

          const initials = name
            ? name.split(' ').slice(0, 2).map(n => n[0]).join('').toUpperCase()
            : 'IC';
          
          const getColor = (str) => {
            let hash = 0;
            const s = str || 'default';
            for (let i = 0; i < s.length; i++) {
              hash = s.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
          };

          // Renderizar imagen SOLO si hay URL y NO ha fallado
          if (url && !hasError) {
            return (
              <div className="w-12 h-12 rounded-full overflow-hidden shadow-sm shrink-0 border border-white bg-white flex items-center justify-center relative">
                <img 
                    src={url} 
                    alt={name} 
                    className="w-full h-full object-cover" 
                    crossOrigin="anonymous"
                    onLoad={(e) => onLoad && onLoad(e.target)}
                    onError={() => {
                        console.log("Error cargando imagen, mostrando iniciales");
                        setHasError(true); // Activar fallback
                    }}
                />
              </div>
            );
          }

          // Fallback: Iniciales con color
          return (
            <div 
              className="w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold shadow-sm shrink-0 border border-white"
              style={{ backgroundColor: getColor(name), color: '#fff' }}
            >
              {initials}
            </div>
          );
        };

        // --- COMPONENTE DE FILA INDIVIDUAL ---
        const CompanyRow = ({ empresa, index, handleEdit, handleDelete }) => {
            const [isHovered, setIsHovered] = useState(false);
            const [dominantColor, setDominantColor] = useState(null);
            
            // Estilo dinámico para el hover
            const rowStyle = isHovered 
                ? {
                    background: dominantColor 
                        ? `linear-gradient(135deg, ${dominantColor} 0%, rgba(0,0,0,0.8) 100%)`
                        : 'linear-gradient(135deg, #00529b 0%, #002a50 100%)', // Azul Cervantes por defecto
                    borderLeftColor: dominantColor || '#60a5fa'
                  }
                : {};

            // Callback para extraer color si la imagen carga bien
            const handleImageLoad = (imgElement) => {
                try {
                    if (window.ColorThief) {
                        const colorThief = new window.ColorThief();
                        const color = colorThief.getColor(imgElement);
                        const rgbColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                        setDominantColor(rgbColor);
                    }
                } catch (e) {
                    // Si falla (CORS), no pasa nada, usará el azul por defecto
                }
            };

            return (
                <div 
                  className={`list-row group relative glass-panel rounded-xl overflow-hidden w-full ${isHovered ? 'is-hovered' : ''}`}
                  style={rowStyle}
                  onMouseEnter={() => setIsHovered(true)}
                  onMouseLeave={() => setIsHovered(false)}
                >
                  {/* WATERMARK DE TEXTO (Estilo Big Typography) */}
                  <div className="text-watermark">
                     {empresa.entidad}
                  </div>

                  {/* CONTENIDO */}
                  <div className="row-content relative z-10 p-4 sm:px-6 flex flex-col sm:flex-row items-start sm:items-center gap-4 sm:gap-6">
                    
                    {/* Logo e Información */}
                    <div className="flex items-center gap-4 min-w-0 sm:w-1/3">
                        <div className="hidden sm:flex font-mono text-slate-400 text-sm font-bold w-6 justify-center shrink-0 transition-colors">
                            #{index + 1}
                        </div>
                        
                        <LogoAvatar 
                            name={empresa.entidad} 
                            url={empresa.logoUrl} 
                            onLoad={handleImageLoad} 
                        />
                        
                        <div className="min-w-0">
                            <h3 className="text-lg font-bold text-slate-800 leading-tight mb-1 truncate transition-colors">
                                {empresa.entidad}
                            </h3>
                            <span className="category-badge inline-flex items-center px-2 py-0.5 rounded text-xs font-medium transition-colors">
                                {empresa.categoria}
                            </span>
                        </div>
                    </div>

                    {/* Descripción */}
                    <div className="hidden md:block flex-1 min-w-0">
                        <p className="description-text text-sm text-slate-600 line-clamp-2 leading-relaxed transition-colors">
                            {empresa.descripcion}
                        </p>
                    </div>

                    {/* Beneficio y Acciones */}
                    <div className="w-full sm:w-auto flex items-center justify-between sm:justify-end gap-4 shrink-0 ml-auto">
                        <div className="benefit-box rounded-lg px-3 py-2 flex items-center gap-2 shadow-sm transition-all min-w-[180px]">
                            <IconPercent className="h-4 w-4 benefit-icon shrink-0" />
                            <div>
                                <p className="benefit-title text-[9px] font-bold uppercase tracking-widest leading-none mb-0.5">Beneficio</p>
                                <p className="benefit-value text-xs font-bold leading-tight">{empresa.beneficio_corto}</p>
                            </div>
                        </div>

                        {/* Botones Admin */}
                        <div className={`flex gap-1 transition-opacity ${isHovered ? 'opacity-100' : 'opacity-0'}`}>
                            <button onClick={() => handleEdit(empresa)} className="p-2 bg-white/90 text-blue-600 rounded-full hover:bg-white shadow-sm" title="Editar">
                                <IconEdit className="h-4 w-4 icon-main" />
                            </button>
                            <button onClick={() => handleDelete(empresa.id)} className="p-2 bg-white/90 text-red-600 rounded-full hover:bg-white shadow-sm" title="Eliminar">
                                <IconTrash className="h-4 w-4 icon-main" />
                            </button>
                        </div>
                    </div>

                    {/* Descripción Móvil */}
                    <div className="md:hidden w-full mt-2 pt-2 border-t border-slate-100/50">
                        <p className="description-text text-xs text-slate-500 line-clamp-3">
                            {empresa.descripcion}
                        </p>
                    </div>
                  </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
          const [companies, setCompanies] = useState([]); 
          const [searchTerm, setSearchTerm] = useState('');
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [currentCompany, setCurrentCompany] = useState(null); 
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            const fetchFromFirebase = async () => {
              if (!window.dbFunctions || !window.db) return;
              try {
                const { collection, getDocs, query, orderBy } = window.dbFunctions;
                const q = query(collection(window.db, "empresas"), orderBy("entidad"));
                const querySnapshot = await getDocs(q);
                
                const data = querySnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                setCompanies(data);
              } catch (error) {
                console.error("Error cargando datos:", error);
              } finally {
                setLoading(false);
              }
            };

            window.addEventListener('firebase-ready', fetchFromFirebase);
            if (window.db) fetchFromFirebase();
            return () => window.removeEventListener('firebase-ready', fetchFromFirebase);
          }, []);

          // --- EXPORTAR A EXCEL ---
          const handleExportExcel = () => {
            if (companies.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }
            try {
                // Preparar datos limpios para Excel
                const dataToExport = companies.map(({ id, logoUrl, ...rest }) => rest);
                
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Empresas");
                
                // Nombre del archivo con fecha
                const date = new Date().toISOString().slice(0,10);
                XLSX.writeFile(wb, `Empresas_Amigas_Cervantes_${date}.xlsx`);
            } catch (e) {
                console.error("Error exportando Excel:", e);
                alert("Hubo un error al generar el Excel.");
            }
          };

          const handleMigrateData = async () => {
             if (!window.confirm(`¿Estás seguro de cargar empresas iniciales a Firebase?`)) return;
             setLoading(true);
             const { addDoc, collection } = window.dbFunctions;
             try {
                 // Usar INITIAL_DATA_SEED (Definido arriba con datos completos en implementación real)
                 const promises = INITIAL_DATA_SEED.map(item => addDoc(collection(window.db, "empresas"), item));
                 await Promise.all(promises);
                 alert("¡Datos cargados correctamente! Recarga la página.");
                 window.location.reload();
             } catch (e) {
                 console.error(e);
                 alert("Error al cargar datos");
             }
             setLoading(false);
          };

          const filteredCompanies = useMemo(() => {
            if (!searchTerm) return companies;
            const lowerTerm = searchTerm.toLowerCase();
            return companies.filter(company => {
              return (
                (company.entidad && company.entidad.toLowerCase().includes(lowerTerm)) ||
                (company.descripcion && company.descripcion.toLowerCase().includes(lowerTerm)) ||
                (company.categoria && company.categoria.toLowerCase().includes(lowerTerm)) ||
                (company.beneficio_corto && company.beneficio_corto.toLowerCase().includes(lowerTerm))
              );
            });
          }, [companies, searchTerm]);

          const handleEdit = (company) => { setCurrentCompany(company); setIsModalOpen(true); };
          const handleAddNew = () => { setCurrentCompany(null); setIsModalOpen(true); };

          const handleDelete = async (id) => {
            if (window.confirm("¿Seguro que deseas eliminar esta empresa permanentemente?")) {
              try {
                  const { deleteDoc, doc } = window.dbFunctions;
                  await deleteDoc(doc(window.db, "empresas", id));
                  setCompanies(prev => prev.filter(c => c.id !== id));
              } catch (e) { alert("Error: " + e.message); }
            }
          };

          const handleSave = async (e) => {
            e.preventDefault();
            setLoading(true);
            const formData = new FormData(e.target);
            const companyData = {
                entidad: formData.get('entidad'),
                beneficio_corto: formData.get('beneficio_corto'),
                descripcion: formData.get('descripcion'),
                categoria: formData.get('categoria'),
                logoUrl: formData.get('logoUrl')
            };
            const { addDoc, updateDoc, doc, collection } = window.dbFunctions;
            try {
                if (currentCompany) {
                  const companyRef = doc(window.db, "empresas", currentCompany.id);
                  await updateDoc(companyRef, companyData);
                  setCompanies(prev => prev.map(c => c.id === currentCompany.id ? { ...c, ...companyData } : c));
                } else {
                  const docRef = await addDoc(collection(window.db, "empresas"), companyData);
                  setCompanies(prev => [{ id: docRef.id, ...companyData }, ...prev]);
                }
                setIsModalOpen(false);
            } catch (e) { alert("Error: " + e.message); } finally { setLoading(false); }
          };

          return (
            <div className="min-h-screen font-sans text-slate-800 bg-fixed bg-cover bg-center"
                 style={{ backgroundImage: "url('https://i.postimg.cc/dtDHVQ1X/image.png')" }}>
              
              <div className="min-h-screen bg-slate-900/40 backdrop-blur-[3px]">
                
                <header className="sticky top-0 z-30 glass-header shadow-lg">
                  <div className="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div className="flex items-center gap-4">
                      <img src="https://i.postimg.cc/1XVj0682/Cervantes.png" alt="Institución Cervantes" className="h-12 object-contain filter drop-shadow-md" />
                      <div className="hidden md:block w-px h-10 bg-white/30 mx-2"></div>
                      <h1 className="text-xl md:text-2xl font-bold text-white tracking-wide drop-shadow-md hidden md:block">Empresas Amigas</h1>
                    </div>
                    
                    <div className="flex items-center gap-3 w-full md:w-auto">
                      <div className="relative w-full md:w-80 group">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                          <IconSearch className="h-5 w-5 text-blue-100 group-focus-within:text-white transition-colors" />
                        </div>
                        <input
                          type="text"
                          className="block w-full pl-10 pr-3 py-2 border border-white/20 rounded-full leading-5 bg-white/10 text-white placeholder-blue-100 focus:outline-none focus:bg-white/20 focus:ring-2 focus:ring-white/50 focus:border-transparent sm:text-sm transition-all duration-300 backdrop-blur-sm shadow-inner"
                          placeholder="Buscar convenio..."
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                        />
                      </div>
                      
                      <div className="flex gap-2">
                          <button onClick={handleExportExcel} className="flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-full text-sm font-semibold shadow-lg hover:shadow-green-500/30 transition-all transform hover:-translate-y-0.5" title="Descargar Excel">
                            <IconDownload className="h-4 w-4" />
                            <span className="hidden lg:inline">Excel</span>
                          </button>
                          
                          <button onClick={handleAddNew} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-full text-sm font-semibold shadow-lg hover:shadow-blue-500/30 transition-all transform hover:-translate-y-0.5">
                            <IconPlus className="h-4 w-4" />
                            <span className="hidden lg:inline">Nueva</span>
                          </button>
                      </div>
                    </div>
                  </div>
                </header>

                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                  <div className="mb-6 flex items-center justify-between text-white/90">
                    <p className="text-sm font-medium drop-shadow-sm">
                      Mostrando <span className="font-bold text-white text-lg">{filteredCompanies.length}</span> convenios activos
                      {loading && <span className="ml-2 text-xs opacity-75">(Sincronizando...)</span>}
                    </p>
                  </div>

                  {/* VISTA DE LISTA */}
                  {filteredCompanies.length > 0 ? (
                    <div className="flex flex-col gap-4 pb-20">
                      {filteredCompanies.map((empresa, index) => (
                        <CompanyRow 
                            key={empresa.id} 
                            empresa={empresa} 
                            index={index} 
                            handleEdit={handleEdit} 
                            handleDelete={handleDelete} 
                        />
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-20 glass-panel rounded-3xl shadow-2xl">
                      <div className="bg-white/20 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4 backdrop-blur-sm border border-white/30">
                        <IconBuilding className="h-10 w-10 text-white" />
                      </div>
                      <h3 className="text-xl font-bold text-slate-800 drop-shadow-md">
                          {loading ? "Cargando datos..." : "No hay resultados"}
                      </h3>
                      {!loading && (
                          <div className="mt-4">
                            <button onClick={handleMigrateData} className="px-6 py-2 bg-green-600 text-white rounded-full text-sm font-bold hover:bg-green-700 transition-colors shadow-lg flex items-center gap-2 mx-auto">
                                <IconCloudUpload className="h-4 w-4" /> Migrar Datos Iniciales
                            </button>
                          </div>
                      )}
                    </div>
                  )}
                </main>
              </div>

              {/* MODAL */}
              {isModalOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                  <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => !loading && setIsModalOpen(false)}></div>
                  <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden animate-in fade-in zoom-in duration-200">
                    <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                      <h3 className="text-lg font-bold text-slate-800">{currentCompany ? 'Editar Empresa' : 'Nueva Empresa'}</h3>
                      <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600" disabled={loading}><IconX className="h-5 w-5" /></button>
                    </div>
                    <form onSubmit={handleSave} className="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Nombre Entidad</label>
                        <input name="entidad" defaultValue={currentCompany?.entidad} required className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ej: Empresa S.A." />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">URL del Logo (Opcional)</label>
                        <div className="flex gap-2">
                          <div className="relative flex-1">
                            <span className="absolute top-2.5 left-3 text-slate-400"><IconImage className="h-4 w-4" /></span>
                            <input name="logoUrl" defaultValue={currentCompany?.logoUrl} className="w-full pl-9 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="https://..." />
                          </div>
                        </div>
                        <p className="text-xs text-slate-500 mt-1">Si el enlace falla, se mostrarán las iniciales automáticamente.</p>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Beneficio (Resumen)</label>
                        <input name="beneficio_corto" defaultValue={currentCompany?.beneficio_corto || "50% Matrícula / 20% Cuotas"} required className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Categoría</label>
                        <select name="categoria" defaultValue={currentCompany?.categoria || "Empresa Privada"} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                          <option>Empresa Privada</option><option>Gobierno</option><option>Club Deportivo</option><option>Tecnología</option><option>Colegio Profesional</option><option>Salud</option><option>Sindicato</option><option>Mutual</option><option>Educación</option><option>Cooperativa</option><option>Cámara</option><option>Otro</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Descripción</label>
                        <textarea name="descripcion" defaultValue={currentCompany?.descripcion} required rows={4} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Detalles..." />
                      </div>
                      <div className="pt-4 flex gap-3">
                        <button type="button" onClick={() => setIsModalOpen(false)} disabled={loading} className="flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg font-medium hover:bg-slate-50 transition-colors disabled:opacity-50">Cancelar</button>
                        <button type="submit" disabled={loading} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex justify-center items-center gap-2 disabled:opacity-50">
                          {loading ? <span>Guardando...</span> : <><IconSave className="h-4 w-4" /> Guardar</>}
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
